CREATE TABLE students(
    studentId CHAR(6) NOT NULL,
    name VARCHAR(20) NOT NULL,
    password CHAR(32) NOT NULL,
    eMail VARCHAR(256),

    PRIMARY KEY (studentId)
);

CREATE TABLE classes(
    classId CHAR(7) NOT NULL,
    className VARCHAR(30) NOT NULL,

    PRIMARY KEY (classId)
);

CREATE TABLE comments(
    classId CHAR(7) NOT NULL,
    commentId INT UNSIGNED NOT NULL,
    comment TEXT NOT NULL,
    studentId CHAR(6) NOT NULL,
    good INT DEFAULT 0,
    bad INT DEFAULT 0,
    time DATETIME DEFAULT CURRENT_TIMESTAMP,

    PRIMARY KEY (classId, commentId),
    FOREIGN KEY (classId) REFERENCES classes(classId),
    FOREIGN KEY (studentId) REFERENCES students(studentId)
);

CREATE TABLE commentReplies (
    classId CHAR(7) NOT NULL,
    commentId INT UNSIGNED NOT NULL,
    commentReplyId INT UNSIGNED NOT NULL,
    comment TEXT NOT NULL,
    studentId CHAR(6) NOT NULL,
    good INT DEFAULT 0,
    bad INT DEFAULT 0,
    time datetime default CURRENT_TIMESTAMP,

    PRIMARY KEY (classId, commentId, commentReplyId),
    FOREIGN KEY (classId) REFERENCES classes(classId),
    FOREIGN KEY (classId, commentId) REFERENCES comments(classId, commentId),
    FOREIGN KEY (studentId) REFERENCES students(studentId)
);

CREATE TABLE pastQuestions(
    classId CHAR(7) NOT NULL,
    year INT UNSIGNED NOT NULL,
    #1：1クオーター、2：2クオーター、3：3クオーター、4：4クオーター
    semester INT UNSIGNED NOT NULL,
    fileId INT NOT NULL,
    fileName VARCHAR(30),

    PRIMARY KEY (classId, year, semester, fileId),
    FOREIGN KEY (classId) REFERENCES classes(classId),
    CHECK (semester BETWEEN 1 AND 4)
);

CREATE TABLE questionBoards(
    classId CHAR(7) NOT NULL,
    year INT UNSIGNED NOT NULL,
    questionBoardId INT NOT NULL,
    studentId CHAR(6) NOT NULL,
    question TEXT NOT NULL,
    time DATETIME DEFAULT CURRENT_TIMESTAMP,

    PRIMARY KEY (classId, year, questionBoardId),
    FOREIGN KEY (classId) REFERENCES classes(classId)
);

CREATE TABLE questionBoardReplies(
    classId CHAR(7) NOT NULL,
    year INT UNSIGNED NOT NULL,
    questionBoardId INT NOT NULL,
    questionBoardReplyId INT UNSIGNED NOT NULL,
    studentId CHAR(5) NOT NULL,
    reply text NOT NULL,
    time DATETIME DEFAULT CURRENT_TIMESTAMP,

    PRIMARY KEY (classId, year, questionBoardId, questionBoardReplyId),
    FOREIGN KEY (classId) REFERENCES classes(classId),
    FOREIGN KEY (studentId) REFERENCES students(studentId)
);

INSERT INTO students (studentId, name, password) VALUES ("19T325", "fumiya", "password");
INSERT INTO students (studentId, name, password) VALUES ("19T326", "yamada", "password");
INSERT INTO students (studentId, name, password) VALUES ("19T327", "john", "password");

INSERT INTO classes (classId, className) VALUES ("5005040", "情報数学");
INSERT INTO classes (classId, className) VALUES ("5005070", "データ構造とアルゴリズム");

INSERT INTO comments (classId, commentId, comment, studentId) VALUES ("5005070", 1, "hello", "19T325");
INSERT INTO comments (classId, commentId, comment, studentId) VALUES ("5005070", 2, "hello WORLD", "19T326");


SELECT CASE WHEN commentId IS NULL THEN 0 ELSE commentId END commentId FROM comments WHERE classId="5005070" ORDER BY commentId DESC LIMIT 1
